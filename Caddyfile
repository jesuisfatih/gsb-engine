# ---------- Frontend: app.gsb-engine.dev ----------
app.gsb-engine.dev {
	encode zstd gzip

	# CSP header for Shopify iframe
	header Content-Security-Policy "frame-ancestors https://admin.shopify.com https://*.myshopify.com;"

	# Use route block to control directive execution order
	route {
		# API routes - proxy to backend (FIRST)
		reverse_proxy /api/* 127.0.0.1:4000
		
		# Static files and SPA fallback (SECOND)
		root * /srv/gsb/api/dist
		try_files {path} /index.html
		file_server
	}
}

# ---------- API: api.gsb-engine.dev ----------
api.gsb-engine.dev {
	encode zstd gzip
	
	# CORS headers
	header Access-Control-Allow-Origin "https://app.gsb-engine.dev"
	header Access-Control-Allow-Credentials "true"
	
	# Reverse proxy all requests
	reverse_proxy 127.0.0.1:4000
}


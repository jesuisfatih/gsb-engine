{%- comment -%}
  GSB Customizer V52 - Product Button Block
  Replaces default buy buttons with custom button
{%- endcomment -%}

{%- assign gsb_variant = product.selected_or_first_available_variant -%}
{%- assign hide_default_buttons = block.settings.hide_default_buttons | default: true -%}

<div class="gsb-v52-button-wrapper" style="margin: 1.5rem 0;" data-gsb-active="true">
  <button 
    id="gsb-customize-btn-v52"
    onclick="openGSBEditor('{{ product.handle }}', '{{ gsb_variant.id }}')"
    style="
      background: {{ block.settings.button_color | default: '#4c1d95' }};
      color: {{ block.settings.button_text_color | default: '#ffffff' }};
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-family: inherit;
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';"
  >
    âœ¨ {{ block.settings.button_label | default: 'Customize & Add to cart' }}
  </button>
</div>

<!-- GSB Editor Modal -->
<div id="gsb-editor-modal" style="display: none;">
  <div class="gsb-modal-overlay"></div>
  <div class="gsb-modal-container">
    <button class="gsb-modal-close" onclick="closeGSBEditor()" title="Kapat">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <iframe id="gsb-editor-iframe" src="" frameborder="0"></iframe>
  </div>
</div>

<style>
  #gsb-customize-btn-v52:active {
    transform: translateY(0) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
  }
  
  /* GSB Editor Modal Styles */
  #gsb-editor-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 999999;
  }
  
  .gsb-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    animation: gsbFadeIn 0.3s ease;
  }
  
  .gsb-modal-container {
    position: relative;
    width: 100%;
    height: 100%;
    animation: gsbSlideUp 0.3s ease;
  }
  
  .gsb-modal-close {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000000;
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.95);
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
  }
  
  .gsb-modal-close:hover {
    background: #fff;
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }
  
  .gsb-modal-close:active {
    transform: scale(0.95) rotate(90deg);
  }
  
  #gsb-editor-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }
  
  @keyframes gsbFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes gsbSlideUp {
    from { 
      opacity: 0;
      transform: translateY(20px);
    }
    to { 
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    .gsb-modal-close {
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
    }
  }
  
  {% if hide_default_buttons %}
  /* Hide default buy buttons when GSB is active */
  div[data-gsb-active="true"] ~ .shopify-payment-button,
  div[data-gsb-active="true"] ~ .product-form__buttons,
  div[data-gsb-active="true"] ~ button[name="add"],
  div[data-gsb-active="true"] ~ .product__info-wrapper .shopify-payment-button,
  div[data-gsb-active="true"] ~ .product__info-wrapper .product-form__buttons,
  [data-gsb-active="true"] + .shopify-payment-button,
  [data-gsb-active="true"] + .product-form__buttons,
  .product-form:has([data-gsb-active="true"]) .product-form__buttons:not(:has([data-gsb-active])),
  .product-form:has([data-gsb-active="true"]) .shopify-payment-button:not(:has([data-gsb-active])),
  .product-form:has([data-gsb-active="true"]) > button[name="add"]:not([data-gsb-active]) {
    display: none !important;
  }
  {% endif %}
</style>

<script>
  // GSB Editor Modal Functions
  function openGSBEditor(productHandle, variantId) {
    const modal = document.getElementById('gsb-editor-modal');
    const iframe = document.getElementById('gsb-editor-iframe');
    
    if (modal && iframe) {
      // Build editor URL
      const editorUrl = '/apps/gsb/editor?product=' + encodeURIComponent(productHandle) + 
                       '&variantId=' + encodeURIComponent(variantId);
      
      // Set iframe source
      iframe.src = editorUrl;
      
      // Show modal
      modal.style.display = 'block';
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
      
      // Log for debugging
      console.log('[GSB] Opening editor:', editorUrl);
    }
  }
  
  function closeGSBEditor() {
    const modal = document.getElementById('gsb-editor-modal');
    const iframe = document.getElementById('gsb-editor-iframe');
    
    if (modal && iframe) {
      // Hide modal
      modal.style.display = 'none';
      
      // Clear iframe
      iframe.src = '';
      
      // Restore body scroll
      document.body.style.overflow = '';
      
      console.log('[GSB] Editor closed');
    }
  }
  
  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('gsb-editor-modal');
      if (modal && modal.style.display === 'block') {
        closeGSBEditor();
      }
    }
  });
  
  // Close on overlay click
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('gsb-modal-overlay')) {
      closeGSBEditor();
    }
  });
  
  // Hide default buy buttons (fallback)
  (function() {
    if ({{ hide_default_buttons | json }}) {
      document.addEventListener('DOMContentLoaded', function() {
        const gsbWrapper = document.querySelector('[data-gsb-active="true"]');
        if (gsbWrapper) {
          const form = gsbWrapper.closest('form') || gsbWrapper.closest('.product-form') || gsbWrapper.closest('.product__info-wrapper');
          if (form) {
            const selectors = [
              '.product-form__buttons',
              '.shopify-payment-button',
              'button[name="add"]',
              '.btn--add-to-cart',
              '.product-form__submit'
            ];
            selectors.forEach(sel => {
              form.querySelectorAll(sel).forEach(el => {
                if (!el.closest('[data-gsb-active]')) {
                  el.style.display = 'none';
                }
              });
            });
          }
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "GSB Product Button",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "checkbox",
      "id": "hide_default_buttons",
      "label": "Hide Default Buy Buttons",
      "info": "Automatically hide 'Add to cart' and 'Buy it now' buttons",
      "default": true
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "Customize & Add to cart"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Background Color",
      "default": "#4c1d95"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}

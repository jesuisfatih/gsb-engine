{%- comment -%}
  GSB Customizer V52 - Product Button Block
  Replaces default buy buttons with custom button
{%- endcomment -%}

{%- assign gsb_variant = product.selected_or_first_available_variant -%}
{%- assign hide_default_buttons = block.settings.hide_default_buttons | default: true -%}

<div class="gsb-v52-button-wrapper" style="margin: 1.5rem 0;" data-gsb-active="true">
  <button
    id="gsb-customize-btn-v52"
    onclick="openGSBEditor('{{ product.handle }}', '{{ gsb_variant.id }}')"
    style="
      background: {{ block.settings.button_color | default: '#4c1d95' }};
      color: {{ block.settings.button_text_color | default: '#ffffff' }};
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-family: inherit;
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';"
  >
    ✨ {{ block.settings.button_label | default: 'Customize & Add to cart' }}
  </button>
</div>

<!-- GSB Editor Modal -->
<div id="gsb-editor-modal" style="display: none;">
  <div class="gsb-modal-overlay"></div>
  <div class="gsb-modal-container">
    <button class="gsb-modal-close" onclick="closeGSBEditor()" title="Kapat">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <iframe id="gsb-editor-iframe" src="" frameborder="0"></iframe>
  </div>
</div>

<style>
  #gsb-customize-btn-v52:active {
    transform: translateY(0) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
  }

  /* GSB Editor Modal Styles - Force Full Screen */
  #gsb-editor-modal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    z-index: 2147483647 !important; /* Maximum z-index */
    overflow: hidden !important;
  }
  
  .gsb-modal-overlay {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.8) !important;
    backdrop-filter: blur(4px);
    animation: gsbFadeIn 0.3s ease;
    z-index: 2147483646 !important;
  }
  
  .gsb-modal-container {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    animation: gsbSlideUp 0.3s ease;
    z-index: 2147483647 !important;
  }

  .gsb-modal-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    z-index: 2147483647 !important; /* Maximum z-index - always on top */
    width: 48px !important;
    height: 48px !important;
    border: none !important;
    border-radius: 50% !important;
    background: rgba(255, 255, 255, 0.95) !important;
    color: #333 !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    transition: all 0.2s ease !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  .gsb-modal-close:hover {
    background: #fff;
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }

  .gsb-modal-close:active {
    transform: scale(0.95) rotate(90deg);
  }

  #gsb-editor-iframe {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
    z-index: 2147483646 !important;
  }

  @keyframes gsbFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes gsbSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Override ALL Shopify/Theme CSS that might interfere */
  #gsb-editor-modal,
  #gsb-editor-modal *,
  .gsb-modal-overlay,
  .gsb-modal-container,
  #gsb-editor-iframe {
    box-sizing: border-box !important;
  }
  
  /* Hide Shopify elements when modal is open */
  body.gsb-modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    height: 100% !important;
  }
  
  body.gsb-modal-open .shopify-section,
  body.gsb-modal-open header,
  body.gsb-modal-open footer,
  body.gsb-modal-open nav {
    pointer-events: none !important;
  }
  
  /* Mobile responsive */
  @media (max-width: 768px) {
    .gsb-modal-close {
      top: 10px !important;
      right: 10px !important;
      width: 40px !important;
      height: 40px !important;
    }
    
    #gsb-editor-modal,
    .gsb-modal-overlay,
    .gsb-modal-container,
    #gsb-editor-iframe {
      width: 100vw !important;
      height: 100vh !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
    }
  }

  {% if hide_default_buttons %}
  /* Hide default buy buttons when GSB is active */
  div[data-gsb-active="true"] ~ .shopify-payment-button,
  div[data-gsb-active="true"] ~ .product-form__buttons,
  div[data-gsb-active="true"] ~ button[name="add"],
  div[data-gsb-active="true"] ~ .product__info-wrapper .shopify-payment-button,
  div[data-gsb-active="true"] ~ .product__info-wrapper .product-form__buttons,
  [data-gsb-active="true"] + .shopify-payment-button,
  [data-gsb-active="true"] + .product-form__buttons,
  .product-form:has([data-gsb-active="true"]) .product-form__buttons:not(:has([data-gsb-active])),
  .product-form:has([data-gsb-active="true"]) .shopify-payment-button:not(:has([data-gsb-active])),
  .product-form:has([data-gsb-active="true"]) > button[name="add"]:not([data-gsb-active]) {
    display: none !important;
  }
  {% endif %}
</style>

<script>
  // GSB Editor Modal Functions
  function openGSBEditor(productHandle, variantId) {
    const modal = document.getElementById('gsb-editor-modal');
    const iframe = document.getElementById('gsb-editor-iframe');
    
    if (modal && iframe) {
      // Build editor URL with desktop force flag
      const editorUrl = '/apps/gsb/editor?product=' + encodeURIComponent(productHandle) + 
                       '&variantId=' + encodeURIComponent(variantId) +
                       '&forceDesktop=true&modalMode=true';
      
      // Set iframe source
      iframe.src = editorUrl;
      
      // Show modal (force full screen)
      modal.style.display = 'block';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.right = '0';
      modal.style.bottom = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.zIndex = '2147483647';
      
      // Lock body (prevent scroll and interaction with page)
      document.body.classList.add('gsb-modal-open');
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.height = '100%';
      
      // Inject desktop viewport into iframe (after load)
      iframe.onload = function() {
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          const meta = iframeDoc.createElement('meta');
          meta.name = 'viewport';
          meta.content = 'width=1920, initial-scale=1.0';
          iframeDoc.head.appendChild(meta);
          
          // Add desktop force class to body
          if (iframeDoc.body) {
            iframeDoc.body.classList.add('gsb-force-desktop');
            iframeDoc.body.style.minWidth = '1440px';
          }
          
          console.log('[GSB] ✅ Desktop mode injected to iframe');
        } catch (e) {
          console.warn('[GSB] Cannot inject to iframe (cross-origin):', e);
        }
      };
      
      // Log for debugging
      console.log('[GSB] Opening editor:', editorUrl);
    }
  }

  function closeGSBEditor() {
    const modal = document.getElementById('gsb-editor-modal');
    const iframe = document.getElementById('gsb-editor-iframe');
    
    if (modal && iframe) {
      // Hide modal
      modal.style.display = 'none';
      
      // Clear iframe
      iframe.src = '';
      
      // Restore body (unlock)
      document.body.classList.remove('gsb-modal-open');
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      
      console.log('[GSB] Editor closed');
    }
  }

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('gsb-editor-modal');
      if (modal && modal.style.display === 'block') {
        closeGSBEditor();
      }
    }
  });

  // Close on overlay click
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('gsb-modal-overlay')) {
      closeGSBEditor();
    }
  });

  // Hide default buy buttons (fallback)
  (function() {
    if ({{ hide_default_buttons | json }}) {
      document.addEventListener('DOMContentLoaded', function() {
        const gsbWrapper = document.querySelector('[data-gsb-active="true"]');
        if (gsbWrapper) {
          const form = gsbWrapper.closest('form') || gsbWrapper.closest('.product-form') || gsbWrapper.closest('.product__info-wrapper');
          if (form) {
            const selectors = [
              '.product-form__buttons',
              '.shopify-payment-button',
              'button[name="add"]',
              '.btn--add-to-cart',
              '.product-form__submit'
            ];
            selectors.forEach(sel => {
              form.querySelectorAll(sel).forEach(el => {
                if (!el.closest('[data-gsb-active]')) {
                  el.style.display = 'none';
                }
              });
            });
          }
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "GSB Product Button",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "checkbox",
      "id": "hide_default_buttons",
      "label": "Hide Default Buy Buttons",
      "info": "Automatically hide 'Add to cart' and 'Buy it now' buttons",
      "default": true
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "Customize & Add to cart"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Background Color",
      "default": "#4c1d95"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}

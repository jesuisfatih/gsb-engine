{%- comment -%}
  GSB Customizer V52 - Product Button Block
  Replaces default buy buttons with custom button
{%- endcomment -%}

{%- assign gsb_variant = product.selected_or_first_available_variant -%}
{%- assign hide_default_buttons = block.settings.hide_default_buttons | default: true -%}

<div class="gsb-v52-button-wrapper" style="margin: 1.5rem 0;" data-gsb-active="true">
  <button
    id="gsb-customize-btn-v52"
    onclick="openGSBEditor('{{ product.handle }}', '{{ gsb_variant.id }}')"
    style="
      background: {{ block.settings.button_color | default: '#4c1d95' }};
      color: {{ block.settings.button_text_color | default: '#ffffff' }};
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-family: inherit;
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';"
  >
    âœ¨ {{ block.settings.button_label | default: 'Customize & Add to cart' }}
  </button>
</div>

<!-- GSB Editor Modal will be injected to body root via JavaScript -->

<style>
  #gsb-customize-btn-v52:active {
    transform: translateY(0) !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
  }

  /* GSB Editor Modal Styles - NUCLEAR OVERRIDE (beats all Shopify CSS) */
  #gsb-editor-modal {
    all: initial !important;
    display: block !important;
    position: fixed !important;
    inset: 0 !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    min-width: 100vw !important;
    min-height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    z-index: 2147483647 !important;
    overflow: hidden !important;
    transform: none !important;
    transition: none !important;
    box-sizing: border-box !important;
  }

  .gsb-modal-overlay {
    all: initial !important;
    display: block !important;
    position: fixed !important;
    inset: 0 !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    background: rgba(0, 0, 0, 0.85) !important;
    backdrop-filter: blur(4px) !important;
    z-index: 2147483646 !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    transform: none !important;
    box-sizing: border-box !important;
  }

  .gsb-modal-container {
    all: initial !important;
    display: block !important;
    position: fixed !important;
    inset: 0 !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    z-index: 2147483647 !important;
    transform: none !important;
    box-sizing: border-box !important;
  }

  .gsb-modal-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    z-index: 2147483647 !important;
    width: 48px !important;
    height: 48px !important;
    min-width: 48px !important;
    min-height: 48px !important;
    max-width: 48px !important;
    max-height: 48px !important;
    border: none !important;
    border-radius: 50% !important;
    background: rgba(255, 255, 255, 0.98) !important;
    color: #333 !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5) !important;
    transition: all 0.2s ease !important;
    margin: 0 !important;
    padding: 0 !important;
    outline: none !important;
    transform: none !important;
    box-sizing: border-box !important;
  }

  .gsb-modal-close svg {
    width: 24px !important;
    height: 24px !important;
    display: block !important;
  }

  .gsb-modal-close:hover {
    background: #fff !important;
    transform: scale(1.1) rotate(90deg) !important;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6) !important;
  }

  .gsb-modal-close:active {
    transform: scale(0.95) rotate(90deg) !important;
  }

  #gsb-editor-iframe {
    all: initial !important;
    display: block !important;
    position: fixed !important;
    /* âœ… CENTER: 2400x1150 centered, arka site gÃ¶zÃ¼kÃ¼r */
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 2400px !important;
    height: 1150px !important;
    max-width: 2400px !important;
    max-height: 1150px !important;
    min-width: 2400px !important;
    min-height: 1150px !important;
    border: none !important;
    border-radius: 12px !important; /* âœ… Rounded corners */
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important; /* âœ… Shadow */
    margin: 0 !important;
    padding: 0 !important;
    z-index: 2147483646 !important;
    box-sizing: border-box !important;
    background: white !important;
  }

  @keyframes gsbFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes gsbSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Override ALL Shopify/Theme CSS that might interfere */
  #gsb-editor-modal,
  #gsb-editor-modal *,
  .gsb-modal-overlay,
  .gsb-modal-container,
  #gsb-editor-iframe {
    box-sizing: border-box !important;
  }

  /* Hide Shopify elements when modal is open */
  body.gsb-modal-open {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    height: 100% !important;
  }

  body.gsb-modal-open .shopify-section,
  body.gsb-modal-open header,
  body.gsb-modal-open footer,
  body.gsb-modal-open nav {
    pointer-events: none !important;
  }

  /* Mobile/Tablet responsive - Full screen on smaller devices */
  @media (max-width: 1440px) {
    .gsb-modal-close {
      top: 10px !important;
      right: 10px !important;
      width: 40px !important;
      height: 40px !important;
    }

    #gsb-editor-modal,
    .gsb-modal-overlay,
    .gsb-modal-container,
    #gsb-editor-iframe {
      width: 100vw !important;
      height: 100vh !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
      min-width: 100vw !important;
      min-height: 100vh !important;
      top: 0 !important;
      left: 0 !important;
      transform: none !important;
      border-radius: 0 !important;
    }
  }

  {% if hide_default_buttons %}
  /* Hide default buy buttons when GSB is active */
  div[data-gsb-active="true"] ~ .shopify-payment-button,
  div[data-gsb-active="true"] ~ .product-form__buttons,
  div[data-gsb-active="true"] ~ button[name="add"],
  div[data-gsb-active="true"] ~ .product__info-wrapper .shopify-payment-button,
  div[data-gsb-active="true"] ~ .product__info-wrapper .product-form__buttons,
  [data-gsb-active="true"] + .shopify-payment-button,
  [data-gsb-active="true"] + .product-form__buttons,
  .product-form:has([data-gsb-active="true"]) .product-form__buttons:not(:has([data-gsb-active])),
  .product-form:has([data-gsb-active="true"]) .shopify-payment-button:not(:has([data-gsb-active])),
  .product-form:has([data-gsb-active="true"]) > button[name="add"]:not([data-gsb-active]) {
    display: none !important;
  }
  {% endif %}
</style>

<script>
  // GSB Editor Modal Functions - Inject to body root (bypass Shopify containers)
  function openGSBEditor(productHandle, variantId) {
    // Remove existing modal if any
    const existing = document.getElementById('gsb-editor-modal');
    if (existing) {
      existing.remove();
    }
    
      // Build editor URL with desktop force flag
      const editorUrl = '/apps/gsb/editor?product=' + encodeURIComponent(productHandle) + 
                       '&shopifyVariant=' + encodeURIComponent(variantId) +
                       '&forceDesktop=true&modalMode=true';
    
    // Create modal HTML
    const modalHTML = `
      <div id="gsb-editor-modal">
        <div class="gsb-modal-overlay" onclick="closeGSBEditor()"></div>
        <div class="gsb-modal-container">
          <button class="gsb-modal-close" onclick="closeGSBEditor()" title="Kapat">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <iframe id="gsb-editor-iframe" src="${editorUrl}" frameborder="0" allowfullscreen></iframe>
        </div>
      </div>
    `;
    
    // Inject directly to body (bypass all Shopify containers)
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Lock body (prevent scroll)
    document.body.classList.add('gsb-modal-open');
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
    document.body.style.height = '100%';
    document.body.style.top = '0';
    document.body.style.left = '0';
    
    // Get iframe reference
    const iframe = document.getElementById('gsb-editor-iframe');
    
    // Inject desktop mode after load
    if (iframe) {
      iframe.onload = function() {
        try {
          const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
          if (iframeDoc && iframeDoc.body) {
            iframeDoc.body.classList.add('gsb-force-desktop');
            iframeDoc.body.classList.add('gsb-modal-mode');
            console.log('[GSB] âœ… Desktop mode injected');
          }
        } catch (e) {
          console.warn('[GSB] Cross-origin restriction:', e);
        }
      };
    }
    
    console.log('[GSB] âœ… Modal opened:', editorUrl);
  }

  function closeGSBEditor() {
    const modal = document.getElementById('gsb-editor-modal');
    
    if (modal) {
      // Remove modal completely from DOM
      modal.remove();
      
      // Restore body (unlock)
      document.body.classList.remove('gsb-modal-open');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';
      document.body.style.height = '';
      document.body.style.top = '';
      document.body.style.left = '';
      
      console.log('[GSB] âœ… Modal closed');
    }
  }

  // Close on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || e.key === 'Esc') {
      const modal = document.getElementById('gsb-editor-modal');
      if (modal) {
        closeGSBEditor();
      }
    }
  });

  // âœ… Shopify AJAX Cart API Integration (Resmi YÃ¶ntem)
  window.addEventListener('message', function(event) {
    console.log('[GSB] Parent received:', event.data);
    
    if (!event.data || event.data.type !== 'GSB_DESIGN_COMPLETE') {
      // Handle close modal
      if (event.data && event.data.type === 'GSB_CLOSE_MODAL') {
        console.log('[GSB] Close modal requested');
        closeGSBEditor();
      }
      return;
    }
    
    var msg = event.data;
    console.log('[GSB] âœ… Design complete! Processing...');
    
    // Close modal
    closeGSBEditor();
    
    // Method 1: Use checkoutUrl (if available from backend)
    if (msg.checkoutUrl) {
      console.log('[GSB] âœ… Using backend checkoutUrl:', msg.checkoutUrl);
      window.location.href = msg.checkoutUrl;
      return;
    }
    
    // Method 2: Shopify AJAX Cart API (Official fallback)
    console.log('[GSB] Using Shopify AJAX Cart API');
    
    var variantId = msg.variantId;
    
    // Convert GID to numeric ID
    if (variantId && variantId.includes('gid://shopify/ProductVariant/')) {
      variantId = variantId.split('/').pop();
      console.log('[GSB] Converted GID to numeric ID:', variantId);
    }
    
    if (!variantId) {
      console.error('[GSB] âŒ No variantId!');
      alert('Variant ID missing. Cannot add to cart.');
      return;
    }
    
    // Build cart item (Shopify AJAX API format)
    var cartItem = {
      items: [{
        id: parseInt(variantId),
        quantity: 1,
        properties: msg.properties || {}
      }]
    };
    
    console.log('[GSB] ðŸ›’ Adding to cart:', cartItem);
    
    // POST /cart/add.js (Shopify Official Cart API)
    fetch(window.Shopify?.routes?.root + 'cart/add.js' || '/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(cartItem)
    })
    .then(function(response) {
      if (!response.ok) {
        throw new Error('Cart API returned ' + response.status);
      }
      return response.json();
    })
    .then(function(data) {
      console.log('[GSB] âœ… Item added to cart:', data);
      console.log('[GSB] âœ… Redirecting to cart page...');
      window.location.href = '/cart';
    })
    .catch(function(error) {
      console.error('[GSB] âŒ Cart add failed:', error);
      alert('Failed to add to cart. Please try again or add manually.');
    });
  });

  // Hide default buy buttons (fallback)
  (function() {
    if ({{ hide_default_buttons | json }}) {
      document.addEventListener('DOMContentLoaded', function() {
        const gsbWrapper = document.querySelector('[data-gsb-active="true"]');
        if (gsbWrapper) {
          const form = gsbWrapper.closest('form') || gsbWrapper.closest('.product-form') || gsbWrapper.closest('.product__info-wrapper');
          if (form) {
            const selectors = [
              '.product-form__buttons',
              '.shopify-payment-button',
              'button[name="add"]',
              '.btn--add-to-cart',
              '.product-form__submit'
            ];
            selectors.forEach(sel => {
              form.querySelectorAll(sel).forEach(el => {
                if (!el.closest('[data-gsb-active]')) {
                  el.style.display = 'none';
                }
              });
            });
          }
        }
      });
    }
  })();
</script>

{% schema %}
{
  "name": "GSB Product Button",
  "target": "section",
  "templates": ["product"],
  "settings": [
    {
      "type": "checkbox",
      "id": "hide_default_buttons",
      "label": "Hide Default Buy Buttons",
      "info": "Automatically hide 'Add to cart' and 'Buy it now' buttons",
      "default": true
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "Customize & Add to cart"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Background Color",
      "default": "#4c1d95"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}

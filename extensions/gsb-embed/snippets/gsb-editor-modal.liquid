{% comment %}
  GSB Editor Modal
  Opens editor in iframe overlay without leaving Shopify store
{% endcomment %}

<div id="gsb-editor-modal" class="gsb-modal" style="display: none;">
  <div class="gsb-modal-overlay" onclick="closeGSBModal()"></div>
  <div class="gsb-modal-container">
    <div class="gsb-modal-header">
      <h2>Customize Your Design</h2>
      <button class="gsb-modal-close" onclick="closeGSBModal()" aria-label="Close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    <div class="gsb-modal-body">
      <iframe 
        id="gsb-editor-iframe"
        src=""
        frameborder="0"
        allow="clipboard-write; clipboard-read; fullscreen"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-modals"
      ></iframe>
    </div>
  </div>
</div>

<style>
.gsb-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 999999;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: gsbFadeIn 0.2s ease;
}

.gsb-modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(4px);
}

.gsb-modal-container {
  position: relative;
  width: 95vw;
  height: 95vh;
  max-width: 1920px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  z-index: 1;
}

.gsb-modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

.gsb-modal-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #111827;
}

.gsb-modal-close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border: none;
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
  color: #6b7280;
}

.gsb-modal-close:hover {
  background: #e5e7eb;
  color: #111827;
}

.gsb-modal-body {
  flex: 1;
  overflow: hidden;
  position: relative;
}

#gsb-editor-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

@keyframes gsbFadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .gsb-modal-container {
    width: 100vw;
    height: 100vh;
    max-width: none;
    border-radius: 0;
  }
  
  .gsb-modal-header {
    padding: 12px 16px;
  }
  
  .gsb-modal-header h2 {
    font-size: 16px;
  }
}
</style>

<script>
(function() {
  'use strict';
  
  // Open editor modal
  window.openGSBEditor = function(config) {
    const modal = document.getElementById('gsb-editor-modal');
    const iframe = document.getElementById('gsb-editor-iframe');
    
    if (!modal || !iframe) {
      console.error('[GSB] Modal elements not found');
      return;
    }
    
    // Build editor URL
    const params = new URLSearchParams({
      product: config.productHandle || '',
      variant: config.variantId || '',
      surface: config.surfaceId || '',
      shopifyProduct: config.shopifyProductId || '',
      shopifyVariant: config.shopifyVariantId || '',
      t: config.tenantId || '',
      embed: 'true',
      source: 'shopify-modal'
    });
    
    // Use App Proxy URL (stays on Shopify domain)
    const editorUrl = `/apps/gsb/editor?${params.toString()}`;
    
    iframe.src = editorUrl;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    console.log('[GSB] Editor opened in modal');
  };
  
  // Close editor modal
  window.closeGSBModal = function() {
    const modal = document.getElementById('gsb-editor-modal');
    const iframe = document.getElementById('gsb-editor-iframe');
    
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }
    
    if (iframe) {
      iframe.src = '';
    }
    
    console.log('[GSB] Modal closed');
  };
  
  // Listen for messages from iframe
  window.addEventListener('message', function(event) {
    // Verify origin
    if (event.origin !== 'https://app.gsb-engine.dev' && 
        !event.origin.includes('.myshopify.com')) {
      return;
    }
    
    const message = event.data;
    
    switch (message.type) {
      case 'GSB_DESIGN_COMPLETE':
        console.log('[GSB] Design completed:', message.designId);
        
        // Add to cart
        if (message.variantId && message.properties) {
          addToShopifyCart(message.variantId, message.properties);
        }
        
        // Close modal
        closeGSBModal();
        break;
        
      case 'GSB_CLOSE_MODAL':
        closeGSBModal();
        break;
        
      case 'GSB_DESIGN_SAVED':
        console.log('[GSB] Design auto-saved:', message.designId);
        break;
    }
  });
  
  // Add to Shopify cart
  function addToShopifyCart(variantId, properties) {
    const formData = new FormData();
    formData.append('id', variantId);
    formData.append('quantity', '1');
    
    // Add design properties
    for (const [key, value] of Object.entries(properties)) {
      formData.append(`properties[${key}]`, value);
    }
    
    fetch('/cart/add.js', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      console.log('[GSB] Added to cart:', data);
      
      // Show cart drawer or redirect
      if (typeof window.theme !== 'undefined' && window.theme.openCart) {
        window.theme.openCart();
      } else {
        window.location.href = '/cart';
      }
    })
    .catch(error => {
      console.error('[GSB] Cart add failed:', error);
      alert('Failed to add to cart. Please try again.');
    });
  }
  
  // ESC key to close
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('gsb-editor-modal');
      if (modal && modal.style.display !== 'none') {
        closeGSBModal();
      }
    }
  });
  
})();
</script>


{%- liquid
  assign gsb_controls = settings
  if gsb_controls == blank and block and block.settings
    assign gsb_controls = block.settings
  endif
  if gsb_controls == blank and section and section.settings
    assign gsb_controls = section.settings
  endif
-%}

{%- assign gsb_button_label = gsb_controls.button_label | default: gsb_controls.gsb_button_label | default: "Customize & Add to cart" -%}
{%- assign gsb_button_bg = gsb_controls.button_color | default: gsb_controls.gsb_button_color | default: "#4c1d95" -%}
{%- assign gsb_button_text = gsb_controls.button_text_color | default: gsb_controls.gsb_button_text | default: "#ffffff" -%}
{%- assign gsb_button_variant = gsb_controls.button_variant | default: gsb_controls.gsb_button_variant | default: "pill" -%}
{%- assign gsb_button_size = gsb_controls.button_size | default: gsb_controls.gsb_button_size | default: "md" -%}
{%- assign gsb_button_icon = gsb_controls.button_icon | default: gsb_controls.gsb_button_icon | default: "" -%}
{%- assign gsb_button_shadow = gsb_controls.button_shadow | default: gsb_controls.gsb_button_shadow | default: "" -%}
{%- assign gsb_open_mode = gsb_controls.open_mode | default: gsb_controls.gsb_open_mode | default: "navigate" -%}
{%- assign gsb_editor_url = gsb_controls.editor_url | default: gsb_controls.gsb_editor_url | default: "/editor" -%}
{%- assign gsb_api_url = gsb_controls.api_url | default: gsb_controls.gsb_api_url | default: "/api/embed/shortcodes" -%}
{%- assign gsb_mapping_url = gsb_controls.mapping_url | default: gsb_controls.gsb_mapping_url | default: "/api/embed/catalog/mappings" -%}
{%- assign gsb_script_url = gsb_controls.script_url | default: gsb_controls.gsb_script_url | default: "/gsb-shortcode.js" -%}
{%- assign gsb_return_url = gsb_controls.return_url | default: gsb_controls.gsb_return_url | default: "" -%}
{%- assign gsb_mobile_full = gsb_controls.mobile_full_width | default: gsb_controls.gsb_mobile_full_width | default: true -%}
{%- assign gsb_fallback_handle = gsb_controls.fallback_shortcode | default: gsb_controls.gsb_fallback_shortcode | default: "" -%}
{%- assign gsb_show_native = gsb_controls.show_native_buttons | default: gsb_controls.gsb_show_native_buttons | default: true -%}

{%- assign gsb_initial_variant = product.selected_or_first_available_variant -%}
{%- assign gsb_handle = gsb_fallback_handle | default: product.metafields.gsb.shortcode -%}

<div class="product-form__item gsb-product-button">
  <div
    data-gsb-shortcode="{{ gsb_handle }}"
    data-gsb-product-gid="{{ product.admin_graphql_api_id }}"
    data-gsb-variant-id="{{ gsb_initial_variant.admin_graphql_api_id }}"
    data-gsb-mapping-url="{{ gsb_mapping_url }}"
    data-button-label="{{ gsb_button_label }}"
    data-button-bg="{{ gsb_button_bg }}"
    data-button-color="{{ gsb_button_text }}"
    data-button-variant="{{ gsb_button_variant }}"
    data-button-size="{{ gsb_button_size }}"
    data-button-icon="{{ gsb_button_icon }}"
    data-button-shadow="{{ gsb_button_shadow }}"
    data-open-mode="{{ gsb_open_mode }}"
    data-editor-url="{{ gsb_editor_url }}"
    data-api-url="{{ gsb_api_url }}"
    data-return-url="{{ gsb_return_url }}"
    data-mobile-full-width="{{ gsb_mobile_full | default: true }}"
  ></div>
</div>

{% if form and section and gsb_show_native %}
  {% render 'buy-buttons', product: product, form: form, show_dynamic_checkout: section.settings.enable_dynamic_checkout %}
{% endif %}

{%- unless gsb_short_code_loader_included -%}
  {%- assign gsb_short_code_loader_included = true -%}
  <script
    src="{{ gsb_script_url }}"
    data-api-url="{{ gsb_api_url }}"
    data-editor-url="{{ gsb_editor_url }}"
    data-mapping-url="{{ gsb_mapping_url }}"
    defer
  ></script>
{%- endunless -%}
